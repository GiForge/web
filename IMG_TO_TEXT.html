<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CYBER-SCAN // COMPACT HUD</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --cyber-blue: #00f3ff;
            --deep-amber: #ffaa00;
            --glass-bg: rgba(5, 10, 20, 0.8);
            --border-glow: rgba(0, 243, 255, 0.3);
            --font-main: 'Share Tech Mono', monospace;
        }

        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden;
            font-family: var(--font-main); color: var(--cyber-blue);
        }

        /* Video Background */
        #video-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1;
        }

        /* Overlay Scansione */
        .scan-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 2;
            border: 20px solid rgba(0, 243, 255, 0.05);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
        }

        /* BARRA DI COMANDO IN BASSO (WIDGET ACQUISIZIONE) */
        .bottom-hud {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-top: 2px solid var(--cyber-blue);
            padding: 10px 20px;
            z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            gap: 15px;
            clip-path: polygon(2% 0%, 98% 0%, 100% 100%, 0% 100%);
        }

        .hud-group { display: flex; align-items: center; gap: 10px; }

        /* Widget Risultati Flottante */
        .floating-results {
            position: absolute; top: 20px; right: 20px;
            width: 280px; z-index: 90;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-glow);
            border-right: 4px solid var(--deep-amber);
            padding: 10px;
            clip-path: polygon(0% 0%, 100% 0%, 100% 90%, 90% 100%, 0% 100%);
        }

        /* Pulsanti Cyber */
        .btn-cyber {
            background: rgba(0, 243, 255, 0.1);
            border: 1px solid var(--cyber-blue);
            color: var(--cyber-blue);
            padding: 8px 15px;
            font-family: var(--font-main);
            text-transform: uppercase;
            cursor: pointer;
            display: flex; align-items: center; gap: 5px;
            font-size: 0.8rem; transition: 0.2s;
        }

        .btn-cyber:hover { background: var(--cyber-blue); color: #000; }
        .btn-amber { border-color: var(--deep-amber); color: var(--deep-amber); }
        .btn-amber:hover { background: var(--deep-amber); color: #000; }

        /* File Input Hidden */
        #fileInput { display: none; }

        /* Elementi Testuali */
        textarea {
            width: 100%; height: 120px; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(0, 243, 255, 0.1); color: #fff;
            font-family: var(--font-main); font-size: 0.8rem; margin-top: 8px;
            resize: none;
        }

        .status-tag { font-size: 0.65rem; color: var(--deep-amber); letter-spacing: 1px; }

        .progress-mini {
            position: absolute; top: -2px; left: 0; height: 2px;
            background: var(--deep-amber); transition: width 0.3s;
        }

        @media (max-width: 600px) {
            .bottom-hud { flex-direction: column; clip-path: none; padding-bottom: 20px; }
            .floating-results { width: 90%; left: 5%; top: 10px; }
        }
    </style>
</head>
<body>

    <video id="video-bg" autoplay playsinline muted></video>
    <div class="scan-overlay"></div>

    <div id="res-widget" class="floating-results">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="status-tag">[ DATA_STREAM ]</span>
            <i data-lucide="shrink" size="14" style="cursor:pointer" onclick="toggleRes()"></i>
        </div>
        <div id="res-content">
            <textarea id="output-text" readonly placeholder="// WAITING_FOR_UPLINK..."></textarea>
            <button class="btn-cyber btn-amber" style="width:100%; margin-top:5px; font-size:0.6rem;" onclick="copyText()">
                <i data-lucide="copy" size="12"></i> COPY_TO_SYSTEM
            </button>
        </div>
    </div>

    <div class="bottom-hud">
        <div id="progress-bar" class="progress-mini" style="width: 0%"></div>
        
        <div class="hud-group">
            <span id="system-status" class="status-tag">CORE_READY</span>
        </div>

        <div class="hud-group">
            <label for="fileInput" class="btn-cyber">
                <i data-lucide="upload-cloud" size="16"></i> FILE
            </label>
            <input type="file" id="fileInput" accept="image/*">

            <button class="btn-cyber" onclick="processSource('camera')" id="cam-trigger">
                <i data-lucide="aperture" size="18"></i> 
                <span style="font-weight:bold">SCAN_FRAME</span>
            </button>
        </div>

        <div class="hud-group" style="opacity: 0.5; font-size: 0.7rem;">
            V.2.0_OCR_HUD
        </div>
    </div>

    <canvas id="proc-canvas" style="display:none;"></canvas>

<script>
    lucide.createIcons();
    const video = document.getElementById('video-bg');
    const canvas = document.getElementById('proc-canvas');
    const outText = document.getElementById('output-text');
    const sysStatus = document.getElementById('system-status');
    const pBar = document.getElementById('progress-bar');

    // Init Camera
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" }, audio: false 
            });
            video.srcObject = stream;
        } catch (e) { sysStatus.innerText = "CAMERA_ERROR"; }
    }

    // Gestore universale acquisizione (Camera o File)
    async function processSource(type, fileEvent = null) {
        let imageSource;

        if (type === 'camera') {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            imageSource = canvas.toDataURL('image/jpeg');
        } else {
            const file = fileEvent.target.files[0];
            if (!file) return;
            imageSource = await toBase64(file);
        }

        runOCR(imageSource);
    }

    async function runOCR(src) {
        sysStatus.innerText = "ANALYZING...";
        pBar.style.width = "10%";
        
        try {
            const result = await Tesseract.recognize(src, 'ita+eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        let p = Math.round(m.progress * 100);
                        pBar.style.width = p + "%";
                        sysStatus.innerText = `RECOG_${p}%`;
                    }
                }
            });
            outText.value = result.data.text;
            sysStatus.innerText = "SUCCESS";
            setTimeout(() => { pBar.style.width = "0%"; sysStatus.innerText = "CORE_READY"; }, 3000);
        } catch (e) {
            sysStatus.innerText = "FAULT_ERROR";
        }
    }

    // Helper: File to Base64
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    function toggleRes() {
        const content = document.getElementById('res-content');
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
    }

    function copyText() {
        navigator.clipboard.writeText(outText.value);
        sysStatus.innerText = "COPIED";
    }

    document.getElementById('fileInput').addEventListener('change', (e) => processSource('file', e));

    startCamera();
</script>
</body>
</html>