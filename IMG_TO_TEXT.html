<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CYBER-SCAN // TACTICAL HUD V3</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --cyber-blue: #00f3ff;
            --deep-amber: #ffaa00;
            --glass-bg: rgba(5, 10, 20, 0.85);
            --border-glow: rgba(0, 243, 255, 0.3);
            --font-main: 'Share Tech Mono', monospace;
        }

        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden;
            font-family: var(--font-main); color: var(--cyber-blue);
        }

        #video-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Scan Overlay */
        .hud-vignette {
            position: fixed; inset: 0; pointer-events: none; z-index: 2;
            background: radial-gradient(circle, transparent 60%, rgba(0,0,0,0.8) 100%);
            border: 1px solid var(--border-glow);
        }

        /* BARRA DI COMANDO IN BASSO */
        .bottom-hud {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--glass-bg); backdrop-filter: blur(15px);
            border-top: 2px solid var(--cyber-blue);
            padding: 15px 25px; z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            clip-path: polygon(0 20%, 5% 0, 95% 0, 100% 20%, 100% 100%, 0 100%);
        }

        /* WIDGET LATERALI */
        .side-widget {
            position: absolute; left: 20px; bottom: 100px;
            display: flex; flex-direction: column; gap: 10px; z-index: 90;
        }

        .btn-cyber {
            background: rgba(0, 243, 255, 0.1); border: 1px solid var(--cyber-blue);
            color: var(--cyber-blue); padding: 10px;
            font-family: var(--font-main); text-transform: uppercase;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.8rem; transition: 0.2s; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }

        .btn-cyber:hover { background: var(--cyber-blue); color: #000; }
        .btn-active { background: var(--deep-amber); color: #000; border-color: var(--deep-amber); }

        .floating-results {
            position: absolute; top: 20px; right: 20px; width: 300px;
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--border-glow); border-right: 4px solid var(--deep-amber);
            padding: 12px; z-index: 90;
        }

        textarea {
            width: 100%; height: 180px; background: rgba(0,0,0,0.5);
            border: 1px solid rgba(0, 243, 255, 0.2); color: #fff;
            font-family: var(--font-main); font-size: 0.85rem; margin-top: 10px; resize: none;
        }

        .status-tag { font-size: 0.7rem; color: var(--deep-amber); text-shadow: 0 0 5px var(--deep-amber); }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <video id="video-bg" autoplay playsinline muted></video>
    <div class="hud-vignette"></div>

    <div class="side-widget">
        <button id="torchBtn" class="btn-cyber" onclick="toggleTorch()">
            <i data-lucide="zap-off"></i> FLASH_OFF
        </button>
        <div class="status-tag" id="orient-info">MODE: PORTRAIT</div>
    </div>

    <div class="floating-results">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="status-tag">[ ANALYZER_OUTPUT ]</span>
            <i data-lucide="copy" size="16" style="cursor:pointer" onclick="copyText()"></i>
        </div>
        <textarea id="output-text" readonly placeholder="// STANDBY..."></textarea>
    </div>

    <div class="bottom-hud">
        <div class="hud-group">
            <span id="system-status" class="status-tag">SYSTEM_READY</span>
        </div>

        <div style="display: flex; gap: 15px;">
            <label for="fileInput" class="btn-cyber">
                <i data-lucide="file-up"></i> UPLOAD
            </label>
            <input type="file" id="fileInput" accept="image/*">

            <button class="btn-cyber btn-active" onclick="processSource('camera')" style="padding: 10px 30px;">
                <i data-lucide="scan"></i> START_SCAN
            </button>
        </div>

        <div style="font-size: 0.6rem; opacity: 0.6;">TAC_UNIT_01</div>
    </div>

    <canvas id="proc-canvas" style="display:none;"></canvas>

<script>
    lucide.createIcons();
    const video = document.getElementById('video-bg');
    const canvas = document.getElementById('proc-canvas');
    const outText = document.getElementById('output-text');
    const sysStatus = document.getElementById('system-status');
    const torchBtn = document.getElementById('torchBtn');
    const orientInfo = document.getElementById('orient-info');
    
    let videoStream = null;
    let isTorchOn = false;

    // Inizializzazione Video con gestione orientamento
    async function initSystem() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment",
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            });
            video.srcObject = videoStream;
            
            // Monitora orientamento
            window.addEventListener('resize', updateOrientationUI);
            updateOrientationUI();
        } catch (e) {
            sysStatus.innerText = "UPLINK_ERROR";
        }
    }

    function updateOrientationUI() {
        const isLandscape = window.innerWidth > window.innerHeight;
        orientInfo.innerText = isLandscape ? "MODE: LANDSCAPE" : "MODE: PORTRAIT";
    }

    // Gestione Flash (Torcia)
    async function toggleTorch() {
        const track = videoStream.getVideoTracks()[0];
        const capabilities = track.getCapabilities();
        
        if (!capabilities.torch) {
            sysStatus.innerText = "NO_FLASH_HARDWARE";
            return;
        }

        isTorchOn = !isTorchOn;
        try {
            await track.applyConstraints({
                advanced: [{ torch: isTorchOn }]
            });
            torchBtn.classList.toggle('btn-active', isTorchOn);
            torchBtn.innerHTML = isTorchOn ? 
                '<i data-lucide="zap"></i> FLASH_ON' : 
                '<i data-lucide="zap-off"></i> FLASH_OFF';
            lucide.createIcons();
        } catch (e) {
            console.error(e);
        }
    }

    // Acquisizione e OCR
    async function processSource(type, e) {
        let imgData;
        sysStatus.innerText = "ACQUIRING...";

        if (type === 'camera') {
            // Gestione risoluzione e orientamento su Canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            imgData = canvas.toDataURL('image/jpeg', 0.9);
        } else {
            const file = e.target.files[0];
            if(!file) return;
            imgData = await toBase64(file);
        }

        runOCR(imgData);
    }

    async function runOCR(src) {
        outText.value = "// DECRYPTING_DATA...";
        try {
            const result = await Tesseract.recognize(src, 'ita+eng', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        sysStatus.innerText = `SCANNING_${Math.round(m.progress * 100)}%`;
                    }
                }
            });
            outText.value = result.data.text || "// NO_TEXT_DETECTED";
            sysStatus.innerText = "SCAN_SUCCESS";
        } catch (err) {
            sysStatus.innerText = "CORE_FAULT";
        }
    }

    const toBase64 = file => new Promise((res) => {
        const r = new FileReader(); r.readAsDataURL(file);
        r.onload = () => res(r.result);
    });

    function copyText() {
        navigator.clipboard.writeText(outText.value);
        sysStatus.innerText = "COPIED_TO_BUFFER";
    }

    document.getElementById('fileInput').addEventListener('change', (e) => processSource('file', e));

    initSystem();
</script>
</body>
</html>