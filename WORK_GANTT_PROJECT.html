<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProGantt Elite v7.1 - Full Restore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --p-color: #6366f1;
            --p-hover: #818cf8;
            --danger: #f87171;
            --warning: #fbbf24;
            --success: #10b981;
            --bg-app: #0f172a;
            --card-bg: #1e293b;
            --border-color: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --row-height: 58px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-app); color: var(--text-primary); padding: 20px; }

        .app-container { max-width: 1800px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }

        /* Summary Stats */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .summary-card {
            background: var(--card-bg); padding: 15px 20px; border-radius: 16px; border: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 15px;
        }
        .summary-card i { color: var(--p-color); font-size: 20px; background: rgba(99,102,241,0.1); padding: 10px; border-radius: 10px; }
        .summary-card.highlight i { color: var(--success); background: rgba(16,185,129,0.1); }
        .summary-card span { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; }
        .summary-card p { font-size: 1.2rem; font-weight: 700; }

        /* Toolbar */
        .top-bar {
            background: var(--card-bg); padding: 12px 20px; border-radius: 16px; border: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;
        }

        /* Gantt Layout */
        .gantt-container {
            display: grid; grid-template-columns: 280px 1fr; background: var(--card-bg);
            border-radius: 16px; border: 1px solid var(--border-color); overflow: hidden;
        }

        .gantt-sidebar { border-right: 1px solid var(--border-color); background: #1a2235; }
        .sidebar-header { height: 60px; padding: 20px; border-bottom: 2px solid var(--border-color); color: var(--text-secondary); font-size: 12px; font-weight: 700; }
        .sidebar-row { 
            height: var(--row-height); padding: 8px 15px; border-bottom: 1px solid var(--border-color); 
            display: flex; flex-direction: column; justify-content: center; cursor: pointer;
        }
        .sidebar-row:hover { background: rgba(255,255,255,0.05); }
        .sidebar-row .t-name { font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .sidebar-row .t-res { font-size: 10px; color: var(--text-secondary); }

        .gantt-viewport { overflow-x: auto; background: #1e293b; position: relative; }
        .gantt-header { display: flex; height: 60px; border-bottom: 2px solid var(--border-color); background: #1a2235; }
        .day-cell { flex-shrink: 0; border-right: 1px solid var(--border-color); text-align: center; font-size: 10px; padding-top: 10px; color: var(--text-secondary); }
        
        .gantt-body { position: relative; }
        .gantt-row { height: var(--row-height); border-bottom: 1px solid var(--border-color); position: relative; display: flex; align-items: center; }

        /* Task Bars & Progress */
        .task-bar {
            position: absolute; height: 32px; background: #475569; border-radius: 6px; 
            color: white; font-size: 11px; font-weight: 600; display: flex; align-items: center; 
            cursor: pointer; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 2;
        }
        .task-progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--p-color), var(--p-hover));
            display: flex; align-items: center; padding-left: 10px; white-space: nowrap; transition: width 0.4s ease;
        }
        .task-bar.completed .task-progress-fill { background: linear-gradient(90deg, var(--success), #34d399); }
        .task-bar.milestone { background: var(--warning) !important; width: 18px !important; height: 18px !important; transform: rotate(45deg); border: 2px solid var(--bg-app); overflow: visible; }
        
        .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--danger); z-index: 5; opacity: 0.5; pointer-events: none; }

        /* Modal & Form */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 500px; padding: 30px; border-radius: 20px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto; }
        .btn { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; transition: 0.2s; }
        .btn-p { background: var(--p-color); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .btn-outline:hover { background: var(--border-color); }
        input, select { width: 100%; padding: 12px; margin: 8px 0 16px; background: var(--bg-app); border: 1px solid var(--border-color); border-radius: 8px; color: white; }
        
        .slider-container { background: var(--bg-app); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        input[type=range] { margin: 10px 0; accent-color: var(--p-color); }
    </style>
</head>
<body>

<div class="app-container">
    <div class="summary-grid">
        <div class="summary-card"><i class="fas fa-tasks"></i><div><span>Task</span><p id="sum-tasks">0</p></div></div>
        <div class="summary-card highlight"><i class="fas fa-chart-line"></i><div><span>Avanzamento Totale</span><p id="sum-progress">0%</p></div></div>
        <div class="summary-card"><i class="fas fa-calendar-check"></i><div><span>Durata</span><p id="sum-duration">0 gg</p></div></div>
        <div class="summary-card"><i class="fas fa-euro-sign"></i><div><span>Budget</span><p id="sum-cost">€ 0</p></div></div>
    </div>

    <header class="top-bar">
        <h2 style="font-size: 1.1rem; color: var(--p-color);"><i class="fas fa-project-diagram"></i> PROGANTT <span style="color:white">V7.1</span></h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline" title="Zoom Out" onclick="changeZoom(-10)"><i class="fas fa-minus"></i></button>
            <button class="btn btn-outline" title="Zoom In" onclick="changeZoom(10)"><i class="fas fa-plus"></i></button>
            <button class="btn btn-p" onclick="openModal()"><i class="fas fa-plus"></i> Nuovo Task</button>
            <div style="width: 1px; height: 30px; background: var(--border-color); margin: 0 5px;"></div>
            <button class="btn btn-outline" title="Esporta JSON" onclick="exportData()"><i class="fas fa-download"></i></button>
            <button class="btn btn-outline" title="Importa JSON" onclick="document.getElementById('fileIn').click()"><i class="fas fa-upload"></i></button>
            <input type="file" id="fileIn" hidden accept=".json" onchange="importData(event)">
        </div>
    </header>

    <div class="gantt-container">
        <aside class="gantt-sidebar"><div class="sidebar-header">PIANO ATTIVITÀ</div><div id="sidebar-rows-container"></div></aside>
        <section class="gantt-viewport">
            <div class="gantt-header" id="gantt-header"></div>
            <div class="gantt-body" id="gantt-body"></div>
        </section>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-bottom: 20px;">Gestione Attività</h3>
        <input type="hidden" id="t-id">
        <label>Nome Task</label><input type="text" id="t-name">
        <div style="display: flex; gap: 15px;">
            <div style="flex:1"><label>Inizio</label><input type="date" id="t-start"></div>
            <div style="flex:1"><label>Fine</label><input type="date" id="t-end"></div>
        </div>
        <div class="slider-container">
            <label style="display: flex; justify-content: space-between;">AVANZAMENTO <span id="progress-val" style="color:var(--p-color)">0%</span></label>
            <input type="range" id="t-progress" min="0" max="100" value="0" oninput="document.getElementById('progress-val').innerText = this.value + '%'">
        </div>
        <div style="display: flex; gap: 15px;">
            <div style="flex:1"><label>Risorsa</label><input type="text" id="t-resource"></div>
            <div style="flex:1"><label>Costo (€)</label><input type="number" id="t-cost" value="0"></div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
            <input type="checkbox" id="t-is-milestone" style="width:auto; margin:0;"> <label style="margin:0; text-transform: none;">Questa è una milestone</label>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-p" style="flex:1; justify-content: center;" onclick="saveTask()">Salva</button>
            <button id="del-btn" class="btn" style="background:var(--danger); color:white; display:none" onclick="deleteTask()">Elimina</button>
            <button class="btn btn-outline" onclick="closeModal()">Annulla</button>
        </div>
    </div>
</div>

<script>
    let tasks = [];
    let zoom = 50;
    const projectBase = new Date(); projectBase.setDate(projectBase.getDate() - 5);

    function init() {
        const data = localStorage.getItem('gantt_v7_1_data');
        if(data) {
            tasks = JSON.parse(data).map(t => ({...t, startDate: new Date(t.startDate), endDate: new Date(t.endDate)}));
        }
        render();
    }

    function render() {
        const header = document.getElementById('gantt-header');
        const body = document.getElementById('gantt-body');
        const sidebar = document.getElementById('sidebar-rows-container');

        let totCost = 0, totalWeight = 0, completedWeight = 0;
        let lastDate = new Date();
        
        tasks.forEach(t => {
            const dur = Math.max(1, Math.ceil((t.endDate - t.startDate) / 86400000) + 1);
            totalWeight += dur;
            completedWeight += (dur * (parseInt(t.progress || 0) / 100));
            totCost += parseFloat(t.cost || 0);
            if(t.endDate > lastDate) lastDate = new Date(t.endDate);
        });

        const globalProgress = totalWeight > 0 ? Math.round((completedWeight / totalWeight) * 100) : 0;
        document.getElementById('sum-tasks').innerText = tasks.length;
        document.getElementById('sum-cost').innerText = `€ ${totCost.toLocaleString()}`;
        document.getElementById('sum-progress').innerText = `${globalProgress}%`;
        document.getElementById('sum-duration').innerText = `${totalWeight} gg`;

        let maxDate = new Date(lastDate); maxDate.setDate(maxDate.getDate() + 20);
        const totalDays = Math.ceil((maxDate - projectBase) / 86400000);
        header.style.width = body.style.width = (totalDays * zoom) + "px";
        header.innerHTML = "";
        for(let i=0; i<totalDays; i++) {
            const d = new Date(projectBase); d.setDate(d.getDate()+i);
            header.innerHTML += `<div class="day-cell" style="width:${zoom}px">${d.getDate()}<br>${d.toLocaleDateString('it',{weekday:'short'})}</div>`;
        }

        body.innerHTML = `<div class="today-line" style="left:${Math.floor((new Date()-projectBase)/86400000)*zoom}px"></div>`;
        sidebar.innerHTML = "";

        tasks.sort((a,b) => a.startDate - b.startDate).forEach(t => {
            const prog = parseInt(t.progress || 0);
            const sRow = document.createElement('div');
            sRow.className = 'sidebar-row';
            sRow.onclick = () => openModal(t.id);
            sRow.innerHTML = `<div class="t-name">${prog === 100 ? '<i class="fas fa-check-circle" style="color:var(--success)"></i>' : ''}${t.name}</div><div class="t-res">${t.resource || 'Nessuna'} • ${prog}%</div>`;
            sidebar.appendChild(sRow);

            const gRow = document.createElement('div');
            gRow.className = 'gantt-row';
            const left = Math.floor((t.startDate - projectBase) / 86400000) * zoom;
            const w = (Math.ceil((t.endDate - t.startDate) / 86400000) + 1) * zoom;
            
            if(t.isMilestone) {
                gRow.innerHTML = `<div class="task-bar milestone" style="left:${left}px" onclick="openModal(${t.id})"></div>`;
            } else {
                gRow.innerHTML = `<div class="task-bar ${prog === 100 ? 'completed' : ''}" style="left:${left}px; width:${w}px" onclick="openModal(${t.id})"><div class="task-progress-fill" style="width:${prog}%">${w > 70 ? t.name : ''}</div></div>`;
            }
            body.appendChild(gRow);
        });
    }

    function openModal(id = null) {
        document.getElementById('taskModal').style.display = 'flex';
        const d = id ? tasks.find(t => t.id === id) : null;
        document.getElementById('t-id').value = id || "";
        document.getElementById('t-name').value = d ? d.name : "";
        document.getElementById('t-start').value = d ? d.startDate.toISOString().split('T')[0] : "";
        document.getElementById('t-end').value = d ? d.endDate.toISOString().split('T')[0] : "";
        document.getElementById('t-progress').value = d ? (d.progress || 0) : 0;
        document.getElementById('progress-val').innerText = (d ? (d.progress || 0) : 0) + "%";
        document.getElementById('t-resource').value = d ? d.resource : "";
        document.getElementById('t-cost').value = d ? d.cost : 0;
        document.getElementById('t-is-milestone').checked = d ? d.isMilestone : false;
        document.getElementById('del-btn').style.display = id ? "block" : "none";
    }

    function saveTask() {
        const id = document.getElementById('t-id').value;
        const obj = {
            id: id ? parseInt(id) : Date.now(),
            name: document.getElementById('t-name').value || "Nuova Attività",
            startDate: new Date(document.getElementById('t-start').value),
            endDate: new Date(document.getElementById('t-end').value),
            progress: document.getElementById('t-progress').value,
            resource: document.getElementById('t-resource').value,
            cost: document.getElementById('t-cost').value,
            isMilestone: document.getElementById('t-is-milestone').checked
        };
        if(id) tasks = tasks.map(t => t.id === parseInt(id) ? obj : t);
        else tasks.push(obj);
        localStorage.setItem('gantt_v7_1_data', JSON.stringify(tasks));
        closeModal(); render();
    }

    function deleteTask() {
        tasks = tasks.filter(t => t.id !== parseInt(document.getElementById('t-id').value));
        localStorage.setItem('gantt_v7_1_data', JSON.stringify(tasks));
        closeModal(); render();
    }

    function closeModal() { document.getElementById('taskModal').style.display = 'none'; }
    function changeZoom(v) { zoom = Math.max(20, zoom + v); render(); }

    function exportData() {
        const dataStr = JSON.stringify(tasks);
        const blob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'progantt_export.json'; a.click();
    }

    // FUNZIONE DI IMPORTAZIONE RIPRISTINATA E MIGLIORATA
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                tasks = imported.map(t => ({
                    ...t, 
                    startDate: new Date(t.startDate), 
                    endDate: new Date(t.endDate)
                }));
                localStorage.setItem('gantt_v7_1_data', JSON.stringify(tasks));
                render();
                alert("Progetto importato correttamente!");
            } catch (err) {
                alert("Errore nel formato del file!");
            }
        };
        reader.readAsText(file);
    }

    init();
</script>
</body>
</html>