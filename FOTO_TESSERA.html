<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIOMETRIC ID PRO - DRAG & ZOOM</title>
    <style>
        :root { --amber: #ffb000; --cyan: #00f3ff; --bg: #020617; }
        * { box-sizing: border-box; touch-action: none; } /* Impedisce il rimbalzo della pagina su mobile */
        
        body { 
            background: var(--bg); color: #fff; font-family: sans-serif; 
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }

        /* VISORE FISSO */
        .viewer {
            position: relative; width: 100%; height: 50vh; flex-shrink: 0;
            background: #000; display: flex; justify-content: center; align-items: center;
            border-bottom: 2px solid var(--cyan);
        }

        .canvas-container {
            position: relative; width: 280px; height: 360px; /* Rapporto 35x45 */
            overflow: hidden; background: #111;
        }

        video, #editor-canvas { position: absolute; inset: 0; width: 100%; height: 100%; }
        video { transform: scaleX(-1); object-fit: cover; z-index: 1; }
        #editor-canvas { z-index: 2; display: none; cursor: move; }

        .overlay { position: absolute; inset: 0; z-index: 10; pointer-events: none; }

        /* AREA CONTROLLI SCORREVOLE */
        .controls {
            flex-grow: 1; overflow-y: auto; padding: 20px;
            background: rgba(10, 15, 30, 0.95); touch-action: pan-y;
        }

        .card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,243,255,0.1); }
        h3 { color: var(--cyan); font-size: 0.75rem; text-transform: uppercase; margin: 0 0 12px 0; }

        .btn-main { background: var(--amber); color: #000; border: none; width: 100%; padding: 16px; font-size: 1rem; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-tool { background: transparent; color: var(--cyan); border: 1px solid var(--cyan); padding: 10px; border-radius: 6px; flex: 1; font-size: 0.8rem; }
        .btn-tool.active { background: var(--cyan); color: #000; }

        .slider-row { margin-bottom: 15px; }
        input[type="range"] { width: 100%; accent-color: var(--cyan); }
        label { font-size: 0.75rem; color: #ccc; display: block; margin-bottom: 5px; }

        select, input[type="number"] { width: 100%; padding: 12px; background: #000; color: #fff; border: 1px solid #334155; border-radius: 8px; }

        #print-modal { display: none; position: fixed; inset: 0; background: #fff; z-index: 1000; overflow-y: auto; padding: 20px; color: #000; }
        .a4-preview { width: 210mm; display: flex; flex-wrap: wrap; gap: 5mm; margin: 0 auto; padding: 10mm; }

        @media print { .no-print { display: none; } #print-modal { position: absolute; display: block; } }
    </style>
</head>
<body>

<div class="viewer no-print">
    <div class="canvas-container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="editor-canvas"></canvas>
        
        <svg class="overlay" viewBox="0 0 350 450">
            <path d="M0 0h350v450H0z" fill="rgba(0,0,0,0.5)" fill-rule="evenodd" mask="url(#m)"/>
            <mask id="m"><rect width="350" height="450" fill="white"/><ellipse cx="175" cy="195" rx="85" ry="115" fill="black"/></mask>
            <ellipse cx="175" cy="195" rx="85" ry="115" fill="none" stroke="var(--cyan)" stroke-width="2" stroke-dasharray="10"/>
            <line x1="0" y1="180" x2="350" y2="180" stroke="var(--amber)" stroke-width="1"/>
        </svg>
    </div>
</div>

<div class="controls no-print">
    <div id="ui-capture">
        <button class="btn-main" id="btn-snap">SCATTA FOTO</button>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-tool" onclick="document.getElementById('file-in').click()">CARICA FILE</button>
            <button class="btn-tool" id="btn-flip">GIRA CAMERA</button>
        </div>
        <input type="file" id="file-in" hidden accept="image/*">
    </div>

    <div id="ui-edit" style="display:none">
        <div class="card">
            <h3>Fine Tuning & Filtri</h3>
            <label>Zoom (o usa due dita / rotella)</label>
            <input type="range" id="zoom-range" min="0.1" max="3" step="0.01" value="1">
            
            <div class="slider-row" style="margin-top:15px">
                <label>Luminosit√†</label>
                <input type="range" id="br" min="50" max="150" value="100">
            </div>
            <div class="slider-row">
                <label>Contrasto</label>
                <input type="range" id="ct" min="50" max="150" value="100">
            </div>
            <div class="btn-group" style="display:flex; gap:10px;">
                <button class="btn-tool" id="btn-beauty">BEAUTY SCAN</button>
                <button class="btn-tool" id="btn-autofix">AUTO-FIX</button>
            </div>
        </div>

        <div class="card">
            <h3>Formato & Copie</h3>
            <select id="fmt-select">
                <option value="35,45">Passaporto / CIE (35x45mm)</option>
                <option value="30,40">Patente (30x40mm)</option>
                <option value="50,50">Visto USA (50x50mm)</option>
            </select>
            <label style="margin-top:10px">Numero di Copie</label>
            <input type="number" id="copy-num" value="4" min="1">
        </div>

        <button class="btn-main" id="btn-print">ANTEPRIMA DI STAMPA</button>
        <button class="btn-tool" onclick="location.reload()" style="width:100%; margin-top:10px; color:red; border-color:red;">ANNULLA</button>
    </div>
</div>

<div id="print-modal">
    <div class="no-print" style="margin-bottom:20px; display:flex; gap:10px;">
        <button class="btn-main" onclick="window.print()">STAMPA ORA</button>
        <button class="btn-tool" onclick="document.getElementById('print-modal').style.display='none'" style="color:#000">CHIUDI</button>
    </div>
    <div class="a4-preview" id="grid"></div>
</div>



<script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('editor-canvas');
    const ctx = canvas.getContext('2d');
    
    let img = new Image();
    let posX = 0, posY = 0, scale = 1.0;
    let isDragging = false, lastX, lastY, lastDist = 0;
    let beauty = false, currentFacing = "user";

    // 1. Inizializzazione Fotocamera
    async function startCam() {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacing, width: 1280 } });
        video.srcObject = s;
    }
    startCam();
    document.getElementById('btn-flip').onclick = () => { currentFacing = currentFacing === "user" ? "environment" : "user"; startCam(); };

    // 2. Setup Editor (Scatto o Caricamento)
    function setupEditor(src) {
        document.getElementById('ui-capture').style.display = 'none';
        document.getElementById('ui-edit').style.display = 'block';
        video.style.display = 'none';
        canvas.style.display = 'block';
        
        img = new Image();
        img.onload = () => {
            canvas.width = 700; canvas.height = 900;
            // Calcolo scala iniziale "cover"
            scale = Math.max(canvas.width / img.width, canvas.height / img.height);
            posX = (canvas.width - img.width * scale) / 2;
            posY = (canvas.height - img.height * scale) / 2;
            document.getElementById('zoom-range').value = scale;
            render();
        };
        img.src = src;
    }

    document.getElementById('btn-snap').onclick = () => {
        const t = document.createElement('canvas');
        t.width = video.videoWidth; t.height = video.videoHeight;
        const tc = t.getContext('2d');
        if(currentFacing === "user") { tc.translate(t.width, 0); tc.scale(-1, 1); }
        tc.drawImage(video, 0, 0);
        setupEditor(t.toDataURL('image/jpeg'));
    };

    document.getElementById('file-in').onchange = (e) => {
        const r = new FileReader();
        r.onload = (ev) => setupEditor(ev.target.result);
        r.readAsDataURL(e.target.files[0]);
    };

    // 3. Logica di Rendering
    function render() {
        const br = document.getElementById('br').value;
        const ct = document.getElementById('ct').value;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.filter = `brightness(${br}%) contrast(${ct}%) blur(${beauty ? 0.6 : 0}px)`;
        ctx.drawImage(img, posX, posY, img.width * scale, img.height * scale);
    }

    // 4. GESTIONE TRASCINAMENTO (Drag) E ZOOM
    const getEvPos = (e) => ({ x: e.touches ? e.touches[0].clientX : e.clientX, y: e.touches ? e.touches[0].clientY : e.clientY });

    const handleStart = (e) => {
        if (e.touches && e.touches.length === 2) {
            lastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        } else {
            isDragging = true;
            const p = getEvPos(e);
            lastX = p.x; lastY = p.y;
        }
    };

    const handleMove = (e) => {
        if (e.touches && e.touches.length === 2) {
            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            const delta = dist / lastDist;
            scale *= delta;
            lastDist = dist;
            document.getElementById('zoom-range').value = scale;
            render();
        } else if (isDragging) {
            const p = getEvPos(e);
            const dx = (p.x - lastX) * (canvas.width / canvas.offsetWidth);
            const dy = (p.y - lastY) * (canvas.height / canvas.offsetHeight);
            posX += dx; posY += dy;
            lastX = p.x; lastY = p.y;
            render();
        }
    };

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('touchstart', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('touchmove', handleMove, { passive: false });
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('touchend', () => { isDragging = false; lastDist = 0; });

    // Zoom con rotella
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        scale *= (e.deltaY < 0 ? 1.05 : 0.95);
        document.getElementById('zoom-range').value = scale;
        render();
    }, { passive: false });

    // Slider Zoom
    document.getElementById('zoom-range').oninput = function() { scale = parseFloat(this.value); render(); };

    // 5. Filtri e Stampa
    document.getElementById('br').oninput = render;
    document.getElementById('ct').oninput = render;
    document.getElementById('btn-beauty').onclick = function() { beauty = !beauty; this.classList.toggle('active'); render(); };
    document.getElementById('btn-autofix').onclick = () => { document.getElementById('br').value = 110; document.getElementById('ct').value = 115; render(); };

    document.getElementById('btn-print').onclick = () => {
        const g = document.getElementById('grid'); g.innerHTML = '';
        const uri = canvas.toDataURL('image/jpeg', 1.0);
        const [w, h] = document.getElementById('fmt-select').value.split(',');
        for (let i = 0; i < document.getElementById('copy-num').value; i++) {
            const i = new Image(); i.src = uri; i.style.width = w+"mm"; i.style.height = h+"mm"; i.style.border = "0.1mm solid #ddd";
            g.appendChild(i);
        }
        document.getElementById('print-modal').style.display = 'block';
    };
</script>
</body>
</html>